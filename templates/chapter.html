{% extends "base.html" %}

{% block title %}{{ chapter.title }} - Физика Квиз{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <h1 class="card-title">
                    Поглавје {{ chapter.chapter_number }}: {{ chapter.title }}
                </h1>
                <a href="/" class="btn btn-secondary mb-3">← Назад кон поглавјата</a>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <h3>Квиз прашања</h3>
                <div id="quiz-container">
                    {% set letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ" %}
                    {% for question in questions %}
                        {% set q_index = loop.index0 %}
                        <div class="question-card mb-4 p-3 border rounded" 
                             id="question_{{ q_index }}"
                             data-correct-answer="{{ question.correct_answer }}">
                            <h5>Прашање {{ loop.index }}: {{ question.question }}</h5>
                            <div class="options">
                                {% for option in question.options %}
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" 
                                           name="question_{{ q_index }}" 
                                           id="q{{ q_index }}_{{ loop.index0 }}" 
                                           value="{{ loop.index0 }}">
                                    <label class="form-check-label" for="q{{ q_index }}_{{ loop.index0 }}">
                                        {{ letters[loop.index0] }}) {{ option }}
                                    </label>
                                </div>
                                {% endfor %}
                            </div>
                            <div class="answer-feedback mt-2" id="feedback_{{ q_index }}" style="display: none;"></div>
                        </div>
                    {% endfor %}
                </div>

                <div class="text-center mt-4">
                    <button class="btn btn-primary btn-lg" onclick="checkAnswers()">
                        Провери одговори
                    </button>
                    <button class="btn btn-secondary btn-lg ms-2" onclick="resetQuiz()">
                        Ресетирај
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
window.addEventListener('load', () => {
    const questionCards = document.querySelectorAll('.question-card');

    window.checkAnswers = function() {
        let correctCount = 0;
        let answeredCount = 0;

        // Remove previous result if it exists
        const existingResult = document.getElementById('quiz-result');
        if (existingResult) existingResult.remove();

        questionCards.forEach((card, index) => {
            const selectedAnswer = document.querySelector(`input[name="question_${index}"]:checked`);
            const feedback = document.getElementById(`feedback_${index}`);
            const correctIndex = parseInt(card.dataset.correctAnswer, 10);

            if (selectedAnswer) {
                answeredCount++;
                const selectedIndex = parseInt(selectedAnswer.value);
                const isCorrect = selectedIndex === correctIndex;

                if (isCorrect) {
                    correctCount++;
                    feedback.innerHTML = '<span class="badge bg-success">Точен одговор!</span>';
                } else {
                    feedback.innerHTML = '<span class="badge bg-danger">Погрешен одговор!</span>';
                }
                feedback.style.display = 'block';
            } else {
                feedback.innerHTML = '<span class="badge bg-warning">Нема избран одговор!</span>';
                feedback.style.display = 'block';
            }
        });

        if (answeredCount === 0) {
            const warningHtml = `
                <div id="quiz-result" class="alert alert-warning mt-3">
                    <h5>Немате избрано одговори.</h5>
                    <p>Изберете најмалку еден одговор пред да проверите.</p>
                </div>
            `;
            document.getElementById('quiz-container').insertAdjacentHTML('afterend', warningHtml);
            return;
        }

        const percentage = Math.round((correctCount / questionCards.length) * 100);
        const resultHtml = `
            <div id="quiz-result" class="alert alert-info mt-3">
                <h5>Резултат: ${correctCount}/${questionCards.length} точни одговори</h5>
                <p>Процентуално: ${percentage}%</p>
            </div>
        `;
        document.getElementById('quiz-container').insertAdjacentHTML('afterend', resultHtml);
    }

    window.resetQuiz = function() {
        document.querySelectorAll('input[type="radio"]').forEach(input => {
            input.checked = false;
        });

        document.querySelectorAll('.answer-feedback').forEach(feedback => {
            feedback.style.display = 'none';
            feedback.textContent = '';
        });

        const resultAlert = document.getElementById('quiz-result');
        if (resultAlert) resultAlert.remove();
    }
});
</script>
{% endblock %}
